> æ¨èå­¦ä¹ æŒ‡æ•°ï¼šâ­ï¸ï¸â­ï¸ï¸â­ï¸ï¸

## 1\. å‰è¨€

æœ¬ç¯‡æˆ‘ä»¬å®ç°ä»»åŠ¡çš„åˆ›å»ºå’ŒçŠ¶æ€ä¿®æ”¹ã€‚æ•ˆæœå¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18186484403d4b939e2f0337f69519ce~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.gif#?w=965&h=825&s=1025526&e=gif&f=150&b=fefefe)

## 2\. åˆ›å»ºä»»åŠ¡

æˆ‘ä»¬å…ˆå®ç°ä»»åŠ¡çš„åˆ›å»ºã€‚ä¿®æ”¹ `prisma/schema.prisma`ï¼š

```typescript
generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

model List {
    id        Int      @id @default(autoincrement())
    name      String
    userId    String
    color     String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    tasks Task[]
}


model Task {
    id        Int       @id @default(autoincrement())
    content   String
    userId    String
    done      Boolean   @default(false)
    expiresAt DateTime?
    createdAt DateTime  @default(now())

    ListId Int
    list   List @relation(fields: [ListId], references: [id], onDelete: Cascade)
}
```

æˆ‘ä»¬åŠ ä¸Šäº† Task è¡¨ç”¨äºå­˜å‚¨ä»»åŠ¡ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶å°† Task ä¸ List åšäº†å…³è”ã€‚

ä¿®æ”¹ Schema åéœ€è¦è¿è¡Œä»¥ä¸‹å‘½ä»¤åŒæ­¥æ•°æ®åº“å¹¶æ›´æ–°å®¢æˆ·ç«¯ï¼š

```typescript
npx prisma migrate dev
```

> æ³¨ï¼šå¦‚æœæ›´æ–°åä¾ç„¶å‡ºç°äº† TypeScript é”™è¯¯ï¼Œé‚£å°±é‡å¯ä¸€ä¸‹ TS Server

æ–°å»º `src/lib/schema/createTask.ts`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```typescript
import { z } from "zod";

export const createTaskSchema = z.object({
  listId: z.number().nonnegative(),
  content: z.string().min(1, {
    message: "è¯·å¡«å†™ä»»åŠ¡å†…å®¹",
  }),
  expiresAt: z.string().optional(),
});

export type CreateTaskSchema = typeof createTaskSchema;
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å£°æ˜äº†è¡¨å•éªŒè¯çš„ Schemaã€‚

æ¥ä¸‹æ¥æ˜¯ä¸ä¸Šç¯‡ç±»ä¼¼çš„ Superforms å’Œè¡¨å•çš„å¤„ç†æµç¨‹ã€‚ä¿®æ”¹ `src/routes/+page.server.ts`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```diff
import type { PageServerLoad, Actions } from './$types.js';
import { superValidate } from 'sveltekit-superforms';
import { createListSchema } from '$lib/schema/createList';
+import { createTaskSchema } from '$lib/schema/createTask';
import { zod } from 'sveltekit-superforms/adapters';
import { fail, error } from '@sveltejs/kit';
import { type List } from '@prisma/client';
import prisma from '$lib/prisma';

export const load: PageServerLoad = async ({ locals }) => {
  const userId = locals.session.userId;
  if (!userId) {
    error(401, 'å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
  }

  try {
    const checkLists: List[] = await prisma.list.findMany({
      where: {
        userId
      }
    });

    return {
      createListForm: await superValidate(zod(createListSchema)),
+     createTaskForm: await superValidate(zod(createTaskSchema)),
      checkLists
    };
  } catch (e) {
    console.error(e);
    error(401, 'æ¸…å•è·å–å¤±è´¥');
  }
};

// ...
```

ä¿®æ”¹ `src/lib/components/ListFooter.svelte`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```typescript
<script lang="ts">
  import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger
  } from '$lib/components/ui/alert-dialog';
  import { enhance } from '$app/forms';
  import { Separator } from '$lib/components/ui/separator';
  import { Button } from '$lib/components/ui/button';
  import { Trash2, CirclePlus } from 'lucide-svelte';
  import { type List } from '@prisma/client';
  import { toast } from 'svelte-sonner';
  import CreateTaskModal from '$lib/components/CreateTaskModal.svelte';

  const { checkList }: { checkList: List } = $props();
  const { createdAt, id } = checkList;

  let loading = $state(false);
</script>

<Separator class="dark:bg-white" />
<footer class="flex h-[60px] w-full items-center justify-between text-sm text-white">
  <p>åˆ›å»ºäº {createdAt?.toLocaleDateString('zh-CN')}</p>
  <div class="flex flex-row">
    <CreateTaskModal {checkList} />
    <AlertDialog>
      <AlertDialogTrigger asChild let:builder>
        <Button builders={[builder]} size={'icon'} variant={'ghost'}>
          <Trash2 />
        </Button>
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ</AlertDialogTitle>
          <AlertDialogDescription>è¯¥æ“ä½œæ— æ³•æ’¤å›</AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>å–æ¶ˆ</AlertDialogCancel>
          <form
            method="POST"
            action="?/deleteList"
            use:enhance={() => {
              loading = true;
              return async ({ result, update }) => {
                loading = false;
                if (result.type === 'success') {
                  toast.success('æ¸…å•åˆ é™¤æˆåŠŸï¼');
                } else {
                  console.log(result);
                  toast.error('æ¸…å•åˆ é™¤å¤±è´¥ï¼');
                }
                update();
              };
            }}
          >
            <input type="hidden" name="id" value={id} />
            <AlertDialogAction type="submit" disabled={loading}>ç¡®å®š</AlertDialogAction>
          </form>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  </div>
</footer>
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬æŠ½ç¦»å‡ºä¸€ä¸ª `<CreateTaskModal>`ç»„ä»¶ä¸“é—¨ç”¨äºå¤„ç†åˆ›å»ºä»»åŠ¡çš„ Modalï¼š

æ–°å»º `src/lib/components/CreateTaskModal.svelte`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```typescript
<script lang="ts">
  import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger
  } from '$lib/components/ui/dialog';
  import {
    FormControl,
    FormField,
    FormLabel,
    FieldErrors,
    FormButton
  } from '$lib/components/ui/form';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import { Popover, PopoverContent, PopoverTrigger } from '$lib/components/ui/popover';
  import { Calendar } from '$lib/components/ui/calendar';
  import { toast } from 'svelte-sonner';
  import { CalendarDays, CirclePlus } from 'lucide-svelte';
  import { type List } from '@prisma/client';
  import {
    CalendarDate,
    DateFormatter,
    type DateValue,
    getLocalTimeZone,
    parseDate,
    today
  } from '@internationalized/date';
  import { createTaskSchema, type CreateTaskSchema } from '$lib/schema/createTask';
  import { type SuperValidated, type Infer, superForm } from 'sveltekit-superforms';
  import { zodClient } from 'sveltekit-superforms/adapters';
  import { ListMap } from '$lib/const';
  import { cn } from '$lib/utils';
  import { page } from '$app/stores';

  const { checkList }: { checkList: List } = $props();
  const { id, name, color } = checkList;

  let open = $state(false);

  let data: SuperValidated<Infer<CreateTaskSchema>> = $page.data.createTaskForm;

  const form = superForm(data, {
    validators: zodClient(createTaskSchema),
    onResult({ result }) {
      if (result.type === 'success') {
        toast.success('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼');
        open = false;
      } else {
        toast.error('ä»»åŠ¡åˆ›å»ºå¤±è´¥!è¯·ç¨åé‡è¯•');
      }
    }
  });

  const { form: formData, enhance, submitting, reset } = form;

  const onOpenChange = (open: boolean) => {
    open = open;
    reset();
  };

  const df = new DateFormatter('zh-CN', {
    dateStyle: 'long'
  });

  let value: DateValue | undefined = $state(undefined);

  $effect(() => {
    value = $formData.expiresAt ? parseDate($formData.expiresAt) : undefined;
  });

  let placeholder: DateValue = $state(today(getLocalTimeZone()));
</script>

<Dialog bind:open {onOpenChange}>
  <DialogTrigger asChild let:builder>
    <Button builders={[builder]} size={'icon'} variant={'ghost'}>
      <CirclePlus />
    </Button>
  </DialogTrigger>
  <DialogContent class="sm:max-w-[425px]">
    <DialogHeader>
      <DialogTitle>æ·»åŠ ä»»åŠ¡</DialogTitle>
      <DialogDescription>ä»»åŠ¡å°†æ·»åŠ åˆ° ã€Œ{name}ã€ æ¸…å•</DialogDescription>
    </DialogHeader>
    <div class="grid gap-4 py-4">
      <form method="POST" action="?/addTask" use:enhance>
        <FormField {form} name="content">
          <FormControl let:attrs>
            <FormLabel>ä»»åŠ¡å†…å®¹ï¼š</FormLabel>
            <Input class="col-span-3" {...attrs} bind:value={$formData.content} />
            <FieldErrors />
          </FormControl>
        </FormField>
        <FormField {form} name="expiresAt">
          <FormControl let:attrs>
            <FormLabel>æˆªæ­¢æ—¥æœŸï¼š</FormLabel>
            <Popover>
              <PopoverTrigger asChild let:builder>
                <Button
                  variant={'outline'}
                  class={cn(
                    'w-full justify-start text-left font-normal',
                    !value && 'text-muted-foreground'
                  )}
                  builders={[builder]}
                >
                  <CalendarDays class="mr-2 h-4 w-4" />
                  {value ? df.format(value.toDate(getLocalTimeZone())) : 'é€‰æ‹©å®Œæˆæ—¥æœŸ'}
                </Button>
              </PopoverTrigger>
              <PopoverContent>
                <Calendar
                  {value}
                  bind:placeholder
                  initialFocus
                  onValueChange={(v) => {
                    if (v) {
                      $formData.expiresAt = v.toString();
                    } else {
                      $formData.expiresAt = '';
                    }
                  }}
                />
              </PopoverContent>
            </Popover>
            <FieldErrors />
            <input hidden value={$formData.expiresAt} name={attrs.name} />
            <input hidden value={id} name="listId" />
          </FormControl>
        </FormField>
        <FormButton
          disabled={$submitting}
          class={cn('mt-4 w-full text-white dark:text-white', ListMap.get(color))}
        >
          ç¡®è®¤
        </FormButton>
      </form>
    </div>
  </DialogContent>
</Dialog>
```

è¿™æ®µä»£ç å°±æ˜¯å®ç°ä¸»è¦çš„å‰ç«¯äº¤äº’ï¼Œå®ç°æ–¹å¼ä¸ä¸Šç¯‡ç±»ä¼¼ï¼Œä¸»è¦æ˜¯æ—¶é—´çš„å¤„ç†çœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä¹‹æ‰€ä»¥ä½¿ç”¨ `@internationalized/date`æ˜¯å› ä¸º Calendar ç»„ä»¶åº•å±‚ä¾èµ–çš„å°±æ˜¯è¿™ä¸ªç»„ä»¶ï¼Œæˆ‘ä»¬æ·»åŠ  Calendar ç»„ä»¶çš„æ—¶å€™ï¼Œä¼šå®‰è£…æ­¤å·¥å…·åº“ã€‚

æœ€åä¿®æ”¹ `src/routes/+page.server.ts`ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```typescript
import type { PageServerLoad, Actions } from "./$types.js";
import { superValidate } from "sveltekit-superforms";
import { createListSchema } from "$lib/schema/createList";
import { createTaskSchema } from "$lib/schema/createTask";
import { zod } from "sveltekit-superforms/adapters";
import { fail, error } from "@sveltejs/kit";
import { type List } from "@prisma/client";
import prisma from "$lib/prisma";

export const load: PageServerLoad = async ({ locals }) => {
  const userId = locals.session.userId;
  if (!userId) {
    error(401, "å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•");
  }

  try {
    const checkLists: List[] = await prisma.list.findMany({
      where: {
        userId,
      },
    });

    return {
      createListForm: await superValidate(zod(createListSchema)),
      createTaskForm: await superValidate(zod(createTaskSchema)),
      checkLists,
    };
  } catch (e) {
    console.error(e);
    error(401, "æ¸…å•è·å–å¤±è´¥");
  }
};

export const actions: Actions = {
  addList: async (event) => {
    const form = await superValidate(event, zod(createListSchema));

    if (!form.valid) {
      return fail(400, {
        form,
      });
    }

    try {
      const userId = event.locals.session.userId;
      // åˆ›å»ºæ¸…å•
      await prisma.list.create({
        data: {
          userId,
          color: form.data.color,
          name: form.data.name,
        },
      });
    } catch (e) {
      console.error(e);
      return fail(400, {
        form,
        message: "æ¸…å•åˆ›å»ºå¤±è´¥~",
      });
    }

    console.log(form);
    return {
      form,
    };
  },
  deleteList: async (event) => {
    try {
      const userId = event.locals.session.userId;
      const data = await event.request.formData();
      const id = Number(data.get("id"));
      await prisma.list.delete({
        where: {
          id,
          userId,
        },
      });
    } catch (e) {
      console.error(e);
      return fail(400, {
        message: "åˆ é™¤æ¸…å•å¤±è´¥",
      });
    }
  },
  addTask: async (event) => {
    const form = await superValidate(event, zod(createTaskSchema));

    if (!form.valid) {
      return fail(400, {
        form,
      });
    }

    try {
      const userId = event.locals.session.userId;
      const { content, expiresAt, listId } = form.data;

      await prisma.task.create({
        data: {
          userId,
          content,
          expiresAt: expiresAt ? new Date(expiresAt) : null,
          list: {
            connect: {
              id: listId,
            },
          },
        },
      });
    } catch (e) {
      console.error(e);
      return fail(400, {
        message: "æ·»åŠ ä»»åŠ¡å¤±è´¥",
        form,
      });
    }

    console.log(form);

    return {
      form,
    };
  },
};
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº† addTask è¿™ä¸ª Form actionã€‚

æ­¤æ—¶æµè§ˆå™¨æ•ˆæœå¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/490d8b54d1d24005ac03859b260e654b~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.gif#?w=1262&h=876&s=303273&e=gif&f=53&b=fefefe)

æŸ¥çœ‹æ•°æ®åº“ï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦æˆåŠŸå†™å…¥ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/967acd6f5328480eb878daf2ab40af5b~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=2168&h=594&s=193985&e=png&b=212121)

## 3\. å±•ç¤ºä»»åŠ¡

æ­¤æ—¶æ•°æ®åº”è¯¥æˆåŠŸå†™å…¥ï¼Œæˆ‘ä»¬åœ¨é¡µé¢åŠ è½½çš„æ—¶å€™å°†è¯¥æ•°æ®æŸ¥è¯¢å‡ºæ¥ã€‚

ä¿®æ”¹ `src/routes/+page.server.ts`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```diff
import type { PageServerLoad, Actions } from './$types.js';
import { superValidate } from 'sveltekit-superforms';
import { createListSchema } from '$lib/schema/createList';
import { createTaskSchema } from '$lib/schema/createTask';
import { zod } from 'sveltekit-superforms/adapters';
import { fail, error } from '@sveltejs/kit';
import { type List } from '@prisma/client';
import prisma from '$lib/prisma';

export const load: PageServerLoad = async ({ locals }) => {
  const userId = locals.session.userId;
  if (!userId) {
    error(401, 'å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
  }

  try {
    const checkLists: List[] = await prisma.list.findMany({
      where: {
        userId
      },
+     include: {
+       tasks: true
+     }
    });

    return {
      createListForm: await superValidate(zod(createListSchema)),
      createTaskForm: await superValidate(zod(createTaskSchema)),
      checkLists
    };
  } catch (e) {
    console.error(e);
    error(401, 'æ¸…å•è·å–å¤±è´¥');
  }
};

export const actions: Actions = {
  addList: async (event) => {
    const form = await superValidate(event, zod(createListSchema));

    if (!form.valid) {
      return fail(400, {
        form
      });
    }

    try {
      const userId = event.locals.session.userId;
      // åˆ›å»ºæ¸…å•
      await prisma.list.create({
        data: {
          userId,
          color: form.data.color,
          name: form.data.name
        }
      });
    } catch (e) {
      console.error(e);
      return fail(400, {
        form,
        message: 'æ¸…å•åˆ›å»ºå¤±è´¥~'
      });
    }

    console.log(form);
    return {
      form
    };
  },
  deleteList: async (event) => {
    try {
      const userId = event.locals.session.userId;
      const data = await event.request.formData();
      const id = Number(data.get('id'));
      await prisma.list.delete({
        where: {
          id,
          userId
        }
      });
    } catch (e) {
      console.error(e);
      return fail(400, {
        message: 'åˆ é™¤æ¸…å•å¤±è´¥'
      });
    }
  },
  addTask: async (event) => {
    const form = await superValidate(event, zod(createTaskSchema));

    if (!form.valid) {
      return fail(400, {
        form
      });
    }

    try {
      const userId = event.locals.session.userId;
      const { content, expiresAt, listId } = form.data;

      await prisma.task.create({
        data: {
          userId,
          content,
          expiresAt: expiresAt ? new Date(expiresAt) : null,
          list: {
            connect: {
              id: listId
            }
          }
        }
      });
    } catch (e) {
      console.error(e);
      return fail(400, {
        message: 'æ·»åŠ ä»»åŠ¡å¤±è´¥',
        form
      });
    }

    console.log(form);

    return {
      form
    };
  }
};
```

ç°åœ¨ä¿®æ”¹ä¸»é¡µçš„æ ·å¼ï¼Œä¿®æ”¹ `src/routes/+page.svelte`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```xml
<script lang="ts">
  import type { PageData } from './$types.js';
  import SignedIn from 'clerk-sveltekit/client/SignedIn.svelte';
  import ClerkLoading from 'clerk-sveltekit/client/ClerkLoading.svelte';

  import {
    Card,
    CardDescription,
    CardFooter,
    CardHeader,
    CardTitle,
    CardContent
  } from '$lib/components/ui/card';
  import { Skeleton } from '$lib/components/ui/skeleton';
  import CreateListModal from '$lib/components/CreateListModal.svelte';
  import ListFooter from '$lib/components/ListFooter.svelte';
  import TaskItem from '$lib/components/TaskItem.svelte';
  import { ListMap } from '$lib/const';
  import { cn } from '$lib/utils';

  const { data }: { data: PageData } = $props();
</script>

<Card class="mx-4">
  <CardHeader class="pb-3">
    <CardTitle class="text-lg">
      <SignedIn let:user>
        æ¬¢è¿ {user?.fullName}!
      </SignedIn>
      <ClerkLoading>
        <Skeleton class="h-7 w-[150px]" />
      </ClerkLoading>
    </CardTitle>
    <CardDescription class="text-primary max-w-lg text-balance leading-relaxed">
      é“è™½è¿©ï¼Œä¸è¡Œä¸è‡³ï¼›äº‹è™½å°ï¼Œä¸ä¸ºä¸æˆ
    </CardDescription>
  </CardHeader>
  <CardFooter>
    <CreateListModal />
  </CardFooter>
</Card>

<div class="mx-4 mt-6 flex flex-col gap-4">
  {#if data.checkLists.length > 0}
    {#each data.checkLists as { id, name, color, tasks }, index (id)}
      <Card class={cn('w-full text-white sm:col-span-2', ListMap.get(color))}>
        <CardHeader>
          <CardTitle>{name}</CardTitle>
        </CardHeader>
        <CardContent>
          {#if tasks && tasks.length === 0}
            <p>ç›®å‰æ²¡æœ‰ä»»åŠ¡</p>
          {:else if tasks && tasks.length > 0}
            <div>
              {#each tasks as task (task.id)}
                <TaskItem {task} />
              {/each}
            </div>
          {/if}
        </CardContent>
        <CardFooter class="flex-col pb-2">
          <ListFooter checkList={data.checkLists[index]} />
        </CardFooter>
      </Card>
    {/each}
  {:else}
    <span class="text-center">å°šæœªåˆ›å»ºæ¸…å•ï¼Œå¿«åˆ›å»ºä¸€ä¸ªå§</span>
  {/if}
</div>
```

æ–°å»º `src/lib/components/TaskItem.svelte`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
<script lang="ts">
  import { Checkbox } from '$lib/components/ui/checkbox';
  import { type Task } from '@prisma/client';
  import { cn } from '$lib/utils';
  const { task }: { task: Task } = $props();
</script>

<div class="flex items-center gap-2">
  <Checkbox id={task.id.toString()} class="bg-white" checked={task.done} />
  <label
    for={task.id.toString()}
    class={cn('flex flex-row items-center gap-2', task.done && 'line-through')}
  >
    {task.content}
    {#if task.expiresAt}
      <p
        class={cn('text-xs text-white', {
          'text-red-800': Date.now() - task.expiresAt.getTime() > 0
        })}
      >
        {task.expiresAt.toLocaleDateString()}
      </p>
    {/if}
  </label>
</div>
```

æµè§ˆå™¨æ•ˆæœå¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/251d9ddc350f49279ebf71d3fad89b02~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.gif#?w=1262&h=876&s=881737&e=gif&f=113&b=fefefe)

## 4\. ä¿®æ”¹ä»»åŠ¡çŠ¶æ€

ç°åœ¨æˆ‘ä»¬å®ç°ä»»åŠ¡çŠ¶æ€çš„ä¿®æ”¹ï¼Œå³ç‚¹å‡»å¤é€‰æ¡†çš„æ—¶å€™ï¼Œä¿®æ”¹ä»»åŠ¡çš„å®Œæ•´çŠ¶æ€ã€‚

ä¿®æ”¹ `src/routes/+page.server.ts`ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```typescript
import type { PageServerLoad, Actions } from "./$types.js";
import { superValidate } from "sveltekit-superforms";
import { createListSchema } from "$lib/schema/createList";
import { createTaskSchema } from "$lib/schema/createTask";
import { zod } from "sveltekit-superforms/adapters";
import { fail, error } from "@sveltejs/kit";
import { Prisma } from "@prisma/client";
import prisma from "$lib/prisma";

// eslint-disable-next-line @typescript-eslint/no-unused-vars
const listWithTasks = Prisma.validator<Prisma.ListDefaultArgs>()({
  include: { tasks: true },
});
type ListWithTask = Prisma.ListGetPayload<typeof listWithTasks>;

export const load: PageServerLoad = async ({ locals }) => {
  const userId = locals.session.userId;
  if (!userId) {
    error(401, "å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•");
  }

  try {
    const checkLists: ListWithTask[] = await prisma.list.findMany({
      where: {
        userId,
      },
      include: {
        tasks: true,
      },
    });

    return {
      createListForm: await superValidate(zod(createListSchema)),
      createTaskForm: await superValidate(zod(createTaskSchema)),
      checkLists,
    };
  } catch (e) {
    console.error(e);
    error(401, "æ¸…å•è·å–å¤±è´¥");
  }
};

export const actions: Actions = {
  addList: async (event) => {
    const form = await superValidate(event, zod(createListSchema));

    if (!form.valid) {
      return fail(400, {
        form,
      });
    }

    try {
      const userId = event.locals.session.userId;
      // åˆ›å»ºæ¸…å•
      await prisma.list.create({
        data: {
          userId,
          color: form.data.color,
          name: form.data.name,
        },
      });
    } catch (e) {
      console.error(e);
      return fail(400, {
        form,
        message: "æ¸…å•åˆ›å»ºå¤±è´¥~",
      });
    }

    console.log(form);
    return {
      form,
    };
  },
  deleteList: async (event) => {
    try {
      const userId = event.locals.session.userId;
      const data = await event.request.formData();
      const id = Number(data.get("id"));
      await prisma.list.delete({
        where: {
          id,
          userId,
        },
      });
    } catch (e) {
      console.error(e);
      return fail(400, {
        message: "åˆ é™¤æ¸…å•å¤±è´¥",
      });
    }
  },
  addTask: async (event) => {
    const form = await superValidate(event, zod(createTaskSchema));

    if (!form.valid) {
      return fail(400, {
        form,
      });
    }

    try {
      const userId = event.locals.session.userId;
      const { content, expiresAt, listId } = form.data;

      await prisma.task.create({
        data: {
          userId,
          content,
          expiresAt: expiresAt ? new Date(expiresAt) : null,
          list: {
            connect: {
              id: listId,
            },
          },
        },
      });
    } catch (e) {
      console.error(e);
      return fail(400, {
        message: "æ·»åŠ ä»»åŠ¡å¤±è´¥",
        form,
      });
    }

    console.log(form);

    return {
      form,
    };
  },
  setTask: async (event) => {
    try {
      const data = await event.request.formData();
      const taskId = data.get("taskId") as string;
      const checked = data.get("checked") as string;
      const userId = event.locals.session.userId;

      await prisma.task.update({
        where: {
          id: +taskId,
          userId,
        },
        data: {
          done: checked == "true" ? true : false,
        },
      });
    } catch (e) {
      console.error(e);
      return fail(400, {
        message: "ä¿®æ”¹ä»»åŠ¡å¤±è´¥",
      });
    }
  },
};
```

ä¸»è¦æ˜¯æ·»åŠ ä¸€ä¸ª setTask Form Actionã€‚

ä¿®æ”¹ `src/lib/components/TaskItem.svelte`ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```typescript
<script lang="ts">
  import { Checkbox } from '$lib/components/ui/checkbox';
  import { type Task } from '@prisma/client';
  import { cn } from '$lib/utils';
  const { task }: { task: Task } = $props();
  import { enhance, applyAction, deserialize } from '$app/forms';
  import type { ActionResult } from '@sveltejs/kit';
  import { invalidateAll } from '$app/navigation';
  import { toast } from 'svelte-sonner';

  let taskChecked: boolean = $state(task.done);
  $effect(() => {
    taskChecked = task.done;
  });
</script>

<div class="flex items-center gap-2">
  <Checkbox
    id={task.id.toString()}
    class="bg-white"
    bind:checked={taskChecked}
    onCheckedChange={async (checked) => {
      const formData = new FormData();
      formData.append('taskId', String(task.id));
      formData.append('checked', String(checked));

      const response = await fetch('?/setTask', {
        method: 'POST',
        body: formData
      });

      const result: ActionResult = deserialize(await response.text());
      console.log(result);
      if (result.type === 'success' && checked) {
        toast.success('æ­å–œå®Œæˆä»»åŠ¡');
      } else if (result.type === 'failure' || result.type == 'error') {
        toast.error('ä¿®æ”¹ä»»åŠ¡å¤±è´¥ï¼');
      }
      await invalidateAll();
      applyAction(result);
    }}
  />
  <label
    for={task.id.toString()}
    class={cn('flex flex-row items-center gap-2', task.done && 'line-through')}
  >
    {task.content}
    {#if task.expiresAt}
      <p
        class={cn('text-xs text-white', {
          'text-red-800': Date.now() - task.expiresAt.getTime() > 0
        })}
      >
        {task.expiresAt.toLocaleDateString()}
      </p>
    {/if}
  </label>
</div>
```

æ­¤æ—¶æµè§ˆå™¨æ•ˆæœå¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a30b305ada35402b9270df3c1af3bc0e~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.gif#?w=963&h=790&s=360793&e=gif&f=75&b=fefefe)

## 5\. æ„å»º

ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†é¡¹ç›®ã€‚åœ¨æ­£å¼æ„å»ºä¹‹å‰ï¼Œè¦æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰é”™è¯¯ï¼Œè¿è¡Œï¼š

```bash
npm run check
```

å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª lodash.merge çš„ç±»å‹é”™è¯¯ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12a043fc552547f595d1f7497235adad~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=3242&h=938&s=236958&e=png&b=1e1e1e)

è§£å†³ä¹Ÿå¾ˆç®€å•ï¼Œè¿è¡Œï¼š

```diff
npm i --save-dev @types/lodash.merge
```

å†æ¬¡æ£€æŸ¥ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4137399b00584be9ab3513569d01bd23~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=2394&h=588&s=109566&e=png&b=1e1e1e)

æœ€åï¼Œæˆ‘ä»¬å°†ä»£ç æäº¤ï¼š

```typescript
git add -A && git commit -m "Add Task"
```

æ­¤æ—¶å¯ä»¥è¿è¡Œ `npm run build`è¿›è¡Œæ„å»ºï¼Œè¿è¡Œ `npm run preview`è¿›è¡Œé¢„è§ˆã€‚

å…·ä½“çš„éƒ¨ç½²å‚è€ƒæ„å»ºä¸éƒ¨ç½²ç¯‡é€‰æ‹©åˆé€‚çš„é€‚é…å™¨éƒ¨ç½²å³å¯ã€‚

> ä»“åº“æºç ï¼š`git clone git@github.com:mqyqingfeng/learn-svelte.git`

## 6\. æ­å–œä½ ï¼

çœ‹åˆ°è¿™é‡Œï¼Œæ­å–œä½ å®Œæˆäº†ç¬¬ä¸‰é˜¶æ®µ â€”â€” é¡¹ç›®å®æˆ˜ï¼š

1. ç¬¬ä¸€é˜¶æ®µï¼šSvelte 5 ğŸ‰
2. ç¬¬äºŒé˜¶æ®µï¼šSvelteKit ğŸ‰
3. ç¬¬ä¸‰é˜¶æ®µï¼šé¡¹ç›®å®æˆ˜ ğŸ‰
4. ç¬¬å››é˜¶æ®µï¼šSvelte åŸç†

æ­¤æ—¶ä½ åº”è¯¥å¯¹å¦‚ä½•å¼€å‘ Svelte é¡¹ç›®æœ‰äº†ä¸€ä¸ªè®¤çŸ¥ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥æœ€åä¸€ç« ï¼Œä¹Ÿå°±æ˜¯ Svelte åŸç†ç¯‡ï¼Œäº†è§£ Svelte å“åº”å¼çš„å¥¥ç§˜ã€‚